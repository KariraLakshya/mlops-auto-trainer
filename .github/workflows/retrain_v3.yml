name: V3 - Orchestrator Train & Deploy

on:
  push:
    branches: [ main ]
    paths:
      - 'mlmanifest.json'
      - 'models/**'
      - 'data/**'
      - 'src/**'
      - 'Dockerfile'
  repository_dispatch:
    types: [trigger-retrain-event]
  workflow_dispatch:

permissions:
  contents: write
  packages: write

jobs:
  # --- JOB 1: TRAIN & PROFILE ---
  train:
    runs-on: ubuntu-latest
    # Define outputs so the 'deploy' job can read them
    outputs:
      should_deploy: ${{ steps.check_acc.outputs.deploy_trigger }}
      model_path: ${{ steps.manifest.outputs.model_path }}
    
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install Dependencies
        run: pip install -r requirements.txt

      - name: Parse Manifest
        id: manifest
        run: |
          if [ ! -f mlmanifest.json ]; then exit 1; fi
          TRAIN=$(python -c "import json; print(json.load(open('mlmanifest.json'))['train_script'])")
          DATA=$(python -c "import json; print(json.load(open('mlmanifest.json'))['data_path'])")
          OUT=$(python -c "import json; print(json.load(open('mlmanifest.json'))['model_output_path'])")
          EVAL=$(python -c "import json; print(json.load(open('mlmanifest.json'))['eval_script'])")
          
          echo "train_script=$TRAIN" >> $GITHUB_OUTPUT
          echo "data_path=$DATA" >> $GITHUB_OUTPUT
          echo "model_path=$OUT" >> $GITHUB_OUTPUT
          echo "eval_script=$EVAL" >> $GITHUB_OUTPUT

      - name: Run Training & Profiling
        run: |
          python src/train_wrapper.py \
            --script "${{ steps.manifest.outputs.train_script }}" \
            --data "${{ steps.manifest.outputs.data_path }}" \
            --out "${{ steps.manifest.outputs.model_path }}"

      - name: Commit Drift Stats
        run: |
          git config --global user.name "MLOps Bot"
          git config --global user.email "bot@mlops.com"
          git add metrics/training_stats.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update drift baseline [skip ci]" && git push)

      - name: Evaluate Model
        id: eval
        run: |
          python ${{ steps.manifest.outputs.eval_script }} \
            --model ${{ steps.manifest.outputs.model_path }} \
            --data ${{ steps.manifest.outputs.data_path }} > eval_out.txt
          
          ACC_LINE=$(grep -Eo "EVAL_ACC=[0-9]+\.[0-9]+" eval_out.txt || echo "EVAL_ACC=0.0")
          ACC=${ACC_LINE#EVAL_ACC=}
          echo "accuracy=$ACC" >> $GITHUB_OUTPUT
          echo "Parsed Accuracy: $ACC"

      - name: Check Threshold
        id: check_acc
        run: |
          ACC="${{ steps.eval.outputs.accuracy }}"
          if (( $(echo "$ACC >= 0.80" | bc -l) )); then
            echo "deploy_trigger=true" >> $GITHUB_OUTPUT
            echo "✅ Accuracy $ACC meets threshold."
          else
            echo "deploy_trigger=false" >> $GITHUB_OUTPUT
            echo "❌ Accuracy $ACC is below 0.80. Skipping deploy."
          fi

      # Upload Model so the next job can download it
      - uses: actions/upload-artifact@v4
        with:
          name: model-artifact
          path: ${{ steps.manifest.outputs.model_path }}

  # --- JOB 2: BUILD & PUSH (Only runs if training succeeded) ---
  deploy:
    needs: train
    runs-on: ubuntu-latest
    # Only run if the 'train' job set the flag to true
    if: ${{ needs.train.outputs.should_deploy == 'true' }}
    
    steps:
      - uses: actions/checkout@v4

      # Download the model trained in the previous job
      - uses: actions/download-artifact@v4
        with:
          name: model-artifact
          path: ./model 
          # Note: We download to ./model so Dockerfile COPY model/ works

      # FIX: Convert Repo Owner to Lowercase
      - name: Lowercase Repo Owner
        id: lower_repo
        run: |
          echo "repo_lc=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_OUTPUT

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          # Use the lowercase output from the previous step
          tags: ghcr.io/${{ steps.lower_repo.outputs.repo_lc }}/ml-model:latest