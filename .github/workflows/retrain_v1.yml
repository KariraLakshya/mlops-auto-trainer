name: Retrain V1 - manifest-driven train + gated build

on:
  workflow_dispatch:
  push:
    paths:
      - 'Dockerfile'
      - 'src/**'
      - 'models/**'
      - 'data/**'
      - '.github/workflows/**'
      - 'mlmanifest.json'

permissions:
  contents: read
  packages: write

jobs:
  train:
    runs-on: ubuntu-latest
    outputs:
      accuracy_json: ${{ steps.eval_step.outputs.accuracy_json }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Read manifest (train/eval/data/model paths)
        id: manifest
        run: |
          if [ ! -f mlmanifest.json ]; then
            echo "ERROR: mlmanifest.json not found at repo root" >&2
            exit 1
          fi

          TRAIN_SCRIPT=$(python -c "import json; j=json.load(open('mlmanifest.json')); print(j['train_script'])")
          EVAL_SCRIPT=$(python -c "import json; j=json.load(open('mlmanifest.json')); print(j['eval_script'])")
          DATA_PATH=$(python -c "import json; j=json.load(open('mlmanifest.json')); print(j['data_path'])")
          MODEL_PATH=$(python -c "import json; j=json.load(open('mlmanifest.json')); print(j['model_output_path'])")

          echo "Using train_script=$TRAIN_SCRIPT"
          echo "Using eval_script=$EVAL_SCRIPT"
          echo "Using data_path=$DATA_PATH"
          echo "Using model_output_path=$MODEL_PATH"

          echo "train_script=$TRAIN_SCRIPT" >> $GITHUB_OUTPUT
          echo "eval_script=$EVAL_SCRIPT" >> $GITHUB_OUTPUT
          echo "data_path=$DATA_PATH" >> $GITHUB_OUTPUT
          echo "model_path=$MODEL_PATH" >> $GITHUB_OUTPUT

      - name: Run training wrapper (manifest-driven)
        run: |
          python src/train_wrapper.py \
            --script "${{ steps.manifest.outputs.train_script }}" \
            --data "${{ steps.manifest.outputs.data_path }}" \
            --out "${{ steps.manifest.outputs.model_path }}"

      - name: Debug verify model exists
        run: |
          echo "Checking model path: ${{ steps.manifest.outputs.model_path }}"
          if [ -f "${{ steps.manifest.outputs.model_path }}" ]; then
            echo "Model file FOUND at ${{ steps.manifest.outputs.model_path }}"
            ls -la "${{ steps.manifest.outputs.model_path }}"
          else
            echo "ERROR: Model file NOT FOUND at ${{ steps.manifest.outputs.model_path }}" >&2
            exit 1
          fi

      - name: Evaluate and capture accuracy
        id: eval_step
        run: |
          MODEL="${{ steps.manifest.outputs.model_path }}"
          EVAL="${{ steps.manifest.outputs.eval_script }}"
          DATA="${{ steps.manifest.outputs.data_path }}"

          if [ ! -f "$EVAL" ]; then
            echo "ERROR: Eval script $EVAL not found; cannot evaluate." >&2
            exit 1
          fi

          echo "Running evaluation: python $EVAL --model $MODEL --data $DATA"
          python "$EVAL" --model "$MODEL" --data "$DATA" > eval_out.txt
          cat eval_out.txt

          ACC_LINE=$(grep -Eo "EVAL_ACC=[0-9]+\.[0-9]+" eval_out.txt || echo "EVAL_ACC=0.0")
          ACC=${ACC_LINE#EVAL_ACC=}
          echo "{\"accuracy\": ${ACC}}" > acc.json
          echo "Parsed accuracy=$ACC"
          echo "accuracy_json=$(cat acc.json)" >> $GITHUB_OUTPUT

      - name: Upload model artifact
        uses: actions/upload-artifact@v4
        with:
          name: model-artifact
          path: ${{ steps.manifest.outputs.model_path }}

  build-and-push:
    needs: train
    runs-on: ubuntu-latest
    if: ${{ fromJson(needs.train.outputs.accuracy_json).accuracy >= 0.80 }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download model artifact
        uses: actions/download-artifact@v4
        with:
          name: model-artifact
          path: ./model

      - name: Prepare model for image
        run: |
          mkdir -p model
          ls -la model

      - name: Normalize owner (lowercase)
        id: lower
        run: |
          owner_lower=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "owner_lower=$owner_lower" >> $GITHUB_OUTPUT

      - name: Log in to GitHub Container Registry (GHCR)
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build & push image to GHCR
        uses: docker/build-push-action@v4
        with:
          context: .
          push: true
          tags: ghcr.io/${{ steps.lower.outputs.owner_lower }}/ml-model:${{ github.run_id }}

      - name: Report pushed image
        run: |
          echo "Image pushed: ghcr.io/${{ steps.lower.outputs.owner_lower }}/ml-model:${{ github.run_id }}"
